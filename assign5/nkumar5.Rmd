
## Statistics 523  

### Assignment 3: One-Way S3 Package

The file created from `R CMD build` (or similar approaches using `devtools` or RStudio shortcuts) should be submitted along with this file and its pdf output. I should be able to install the package---perhaps from GitHub.

**Extra credit of up to 10 points**: Use `git` for  version control and publish your results on GitHub. If GitHub is used, the link should be provided.
        	
#### 1. Start development of a package called `oneway` using the RStudio approach, i.e., start with a project. This initial version should be derived from your S3 classes developed for assignment 4 in the file `oneway.R` or similar files. 

``` 
#' Perform a oneway analysis of variance
#'
#' @param z A list of responses grouped by factor level
#' @param ... Addition arguments used by other S3 methods
#'
#' @seealso \code{\link{oneway.factor}}, \code{\link{oneway.formula}},
#' \code{\link{summary.oneway}}, \code{\link{plot.oneway}}, \code{\link{lsmeans}}
#' @examples
#' data(coagulation)
#' attach(coagulation)
#' oneway(split(coag, diet))
#' oneway(diet, coag)
#' oneway(coag~diet)
#' summary.oneway(oneway(coag~diet))
#'
#' lsmeans(oneway(coag~diet))
#' plot(oneway(coag~diet))
#'
#' @export
oneway <- function(z, ...) UseMethod("oneway")
#' @export
oneway.default <- function(z, ...) {


  l <- length(z)
  N <- length(unlist(z))
  sums <- sum(unlist(z)^2)
  g <- sum(sapply(z, function(x) sum(x)^2/length(x)))
  h <- sum(unlist(z))^2/N

  sum.wit <- g - h ## within
  sum.bet <- sums - g ## between
  df.wit <- l - 1
  df.bet <- N - l
  m <- unlist(lapply(z, mean))
  n <- unlist(lapply(z, length))

  if(is.null(names(z))){
    groups <- as.character(1:length(z))
  }
  else{
    groups <- names(z)
  }
  names(m) <- groups
  ## create object, add class, & return
  res <- list(df = c(df.wit, df.bet), SS = c(sum.wit, sum.bet),
              groups = groups, call = match.call(), data = z,
              means = m, n = n, N = N, l = l)
  class(res) <- "oneway"
  return(res)
}


#' oneway.factor
#'
#' S3 method for \code{\link{oneway}} using a response vector and factor
#'
#' @param z A factor of levels for each observation
#' @param y A vector of responses
#' @param ... Addition arguments used by other S3 methods
#'
#' @seealso \code{link{oneway}}
#'
#' @export
oneway.factor <- function(z, y, ...) {
  responses <- oneway.default(split(y, z))
  responses$call <- match.call()
  responses
}
#' oneway.formula
#'
#' An S3 method for \code{\link{oneway}} for formulas.
#'
#' @param formula A formula of the form \code{response~factor}
#' @param data An (optional) data frame used by the formula.
#' @param ... Addition arguments used by other S3 methods
#'
#' @seealso \code{\link{oneway}}
#'
#' @export
oneway.formula <- function(formula, data=list(), ...) {
  frames <- model.frame(formula, data)
  responses <- oneway.factor(frames[,2], frames[,1])
  responses$call <- match.call()
  responses
}

#' @export
print.oneway <- function(x, ...) {
  print(x$call)
  cat("\nWithin SS:", x$SS[1], "on", x$df[1],
      "degrees of freedom.\n")
  cat("Between SS:", x$SS[2], "on", x$df[2],
      "degrees of freedom.\n")
}


#' summary.oneway
#'
#' Creates an Analysis of Variance table for a \code{oneway} object
#'
#' @param object An object of class \code{oneway}
#' @param ... Addition arguments used by other S3 methods
#'
#' @export
summary.oneway <- function(object, ...) {
  attach(object)

  SS.tot <- SS[1] + SS[2]
  DF.tot <- df[1] + df[2]

  MS.wit <- SS[1]/df[1]
  MS.bet <- SS[2]/df[2]

  F <- MS.wit/MS.bet
  p <- pf(F, df[1], df[2], lower.tail = FALSE)

  aov.table <- with(object, cbind(DF = c(df, DF.tot),
                                  SS = c(SS, SS.tot),
                                  MS = c(MS.wit, MS.bet, NA),
                                  F = c(F, NA, NA),
                                  "Pr(>F)" = c(p, NA, NA)))
  rownames(aov.tab) <- c("Among Group", "Within Group",
                         "Total")
  res <- list(call=call, aov.table=aov.table, groups=groups, means=means,
              P = p, MS = c(MS.wit,MS.bet), n = n, N = N, l = l)
  class(res) <- "summary.oneway"
  detach(object)
  return(res)
}

#' @export
print.summary.oneway <- function(x, ...) {

  cat("print: \n\t")
  print(x$call)
  cat("\nMeans:\n")
  print(x$means)
  cat("\n")


  # AOV Table

  printCoefmat(x$aov.table, P.values=TRUE, has.Pvalue=TRUE, signif.stars=TRUE, na.print="")
}


#' Perform Fisher's LSD
#'
#' Testing  pairwise differences using Fisher's LSD proceduce on a
#' \code{oneway} object
#'
#' @param object A \code{oneway} object
#'
#' @export
lsmeans <- function(object) UseMethod("lsmeans")


#' @export
lsmeans.oneway <- function(object, ...) {
  object <- summary(object)

  comparison <- function(i, j){
    d <- object$means[i] - object$means[j]
    SE <- sqrt(object$MS[2]*(1/object$n[i] + 1/object$n[j]))
    d.se <- d/SE
    round(2*pt(abs(d.se), object$N-object$l, lower.tail=FALSE),4)
  }
  p.se <- pairwise.table(compare.levels=compare,
                         level.names=object$groups,
                         p.adjust.method="none")
  result <- list(p.value=p.se, call=match.call())
  class(result) <- "lsmeans"
  result
}

#' Creating boxplot of groups in a \code{oneway} object
#'
#' @param x A \code{oneway} object
#' @param xlab X label
#' @param ylab Y label
#' @param main Main plot title
#' @param ... Optional graphing arguments to be passed to
#' \code{boxplot}
#'@param names Names of factor levels
#' @seealso \code{link{boxplot}}
#'
#' @export
plot.oneway <- function(x, names=x$groups, xlab="Grouping variable",ylab="Response variable", main=capture.output(x$call)){
  boxplot(x=x$data, names=names, xlab=xlab,  main=main)
}


#' @export
print.lsmeans <- function(x, ...){
  cat("Call:\n\t")
  print(x$call)
  cat("\nFisher's LSD Table\n")
  cat("\nP-Values:\n")
  print.table(x$p.value, na.print="-")
}
```

#### 3. Generate a NAMESPACE file using `roxygen2`. That is, export (or less likely import) appropriate functions or S3 methods.

```
# Generated by roxygen2 (4.1.1): do not edit by hand

S3method(lsmeans,default)
S3method(lsmeans,oneway)
S3method(oneway,default)
S3method(oneway,factor)
S3method(oneway,formula)
S3method(plot,oneway)
S3method(print,lsmeans)
S3method(print,oneway)
S3method(print,summary.oneway)
S3method(summary,oneway)
export(lsmeans)
export(oneway)
```

#### 4. Develop a help file called `oneway.Rd`, or similar files, which contains the help information for all the functions defined in `oneway.R`, or in similar files. The help file(s) should be placed in a subdirectory called `man`. You should use `roxygen2` for this process.

#### 5. Create an image file from the `coagulation` data set using `save()` and place `coagulation.rda` in the subdirectory `data`.
```{r}
library(faraway)
data(coagulation)
save(coagulation, file = "./data/coagulation.rda")
```

#### 6. Develop a help file called `coagulation.Rd`, which contains the help information for the `coagulation` data set. This file should be placed in the `man` subdirectory. Again use `roxygen2`.

#### 7. Build the package using the `R CMD build` and the `R CMD check` commands or by RStudio commands or `devtools`. The process should be iterated until bugs are found and corrected. You can use the debugging tools you have learned. Once complete, install the package.
	
#### 8. Show the output from the help files using: `library(oneway)`, `help(oneway)`, help for specific functions, and `help(coagulation)`, etc.
```{r oneway.help}
library(devtools)
install_github("neerajnj10/oneway")

                 
library(utils)
library(tools)
print.help <- function(topic){
  help.raw <- utils:::.getHelpFile(help(topic))
  help.txt <- capture.output(tools:::Rd2txt(help.raw))
  cat(gsub("_", "", help.txt), sep = "\n")
}

library(oneway)
print.help("oneway")
print.help("oneway.factor")
print.help("oneway.formula")
print.help("summary.oneway")
print.help("plot.oneway")
print.help("lsmeans.oneway")
print.help("coagulation")
```
The help files should provide all relevant information.

#### 9. Illustrate your functions using:  
```{r oneway.example}
example(oneway)
```
The example should illustrate all aspects of your code.
